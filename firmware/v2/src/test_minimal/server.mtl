
//--------------------------------------------------------------------------------------------------
// TCP Socket Server
//--------------------------------------------------------------------------------------------------

fun tcpread cnx input=
    Secholn "receive -------";
    Secholn input;
    Iecholn cnx;
    
    let strsub input 5 1 -> idx in
    let strcatlist "pong "::idx::nil -> data in 
    writetcp cnx data 0;
    nil
    ;;

fun tcpevent cnx val msg=
    if val==TCPSTART || val==TCPREAD then tcpread cnx msg
    else if val==TCPCLOSE then (
        // when using the simulator, when reconnecting after a socket is closed
        // the system closes the connection, this is not an issue on real hardware
        closetcp cnx
    );
    0;;

fun cbsrv cnx code msg=
    tcpcb cnx #tcpevent;
    0;;

fun startsocketserver port=
    listentcp port #cbsrv;
    led LED_NOSE RGB_BLUE;
    Secholn "start socket server";
    0;;
