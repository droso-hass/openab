
//--------------------------------------------------------------------------------------------------
// TCP Socket Server
//--------------------------------------------------------------------------------------------------


fun tcpread cnx input=
    Secholn "receive -------";
    Secholn input;
    Iecholn cnx;
    
    let strsub input 5 1 -> idx in
    let strcatlist "pong "::idx::nil -> ret in 
    writetcp cnx ret nil;
    nil
    ;;

fun tcpevent cnx val msg=
    if val==TCPREAD then tcpread cnx msg
    else if val==TCPCLOSE then (
        Secholn "closing socket";
        closetcp cnx
    );
    0;;

fun cbsrv cnx code msg=
    Secholn "========= NEW CONNECTION ================";
    tcpcb cnx #tcpevent;
    0;;

fun startsocketserver port=
    listentcp port #cbsrv;
    Secholn "starthttpsrv";
    0;;
