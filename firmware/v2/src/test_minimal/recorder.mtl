
var isRecording;;
var recBuf;;
var recTime;;
var cpt;;


fun writerecdata data = 
    let strlen data -> len in
    if len > 512 then (
        set cpt = cpt + 1;
        writetcpconn strcatlist "08;"::(itoa cpt)::";"::(strsub data 0 512)::nil
        //writetcpconn strcatlist "08;"::(strsub data 0 512)::nil;
        //writerecdata strsub data 512 nil
    ) else (
        set cpt = cpt + 1;
        writetcpconn strcatlist "08;"::(itoa cpt)::";"::data::nil
        //writetcpconn strcatlist "08;"::data::nil
    );;

/*
fun writerecdata data = 
    let strlen data -> len in
    let writetcpconn strcatlist "08;"::data::nil -> writtenLen in
    if writtenLen == nil then 
        nil
    else if writtenLen-3 < len then
        writerecdata strsub data (len-writtenLen+3) nil
    else writtenLen;;
*/

fun cbrec s = 
    writerecdata strtohex s;
    0;;

fun recorderHandler data = 
    let rev split data ";" nil nil -> x in
    let atoi hd x -> tp in
        if tp == 0 && isRecording > 0 then (
            // stop
            Secholn "recording stopped";
            recStop
        ) else if tp == 1 && isRecording <= 0 then (
            // start
            Secholn "recording ...";
            set recTime = time_ms;
            set cpt = 0;
            recStart 8000 0 #cbrec
        );;
